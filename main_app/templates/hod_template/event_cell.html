{% load custom_filters %}

{% if session %}
{% if session.type_evenement in 'COURS,EXAMEN_PARTIEL,EXAMEN_FINAL,RATTRAPAGE,FORMATION_MILITAIRE,CONFERENCE'|split:',' %}
    <div class="event-cell event-{{ session.type_evenement|lower }}" 
         style="position: absolute; 
                left: {% widthratio session.get_left_position 1 1 %}%; 
                width: {% widthratio session.get_width 1 1 %}%;">
        <div class="event-time">
            {{ session.heure_debut|time:"H:i" }} - {{ session.heure_fin|time:"H:i" }}
        </div>
        <div class="event-title">
            {% if session.type_evenement == 'COURS' and session.matiere %}
                {{ session.matiere.name }}
            {% else %}
                {{ session.get_type_evenement_display }}
                {% if session.titre_evenement %}
                    - {{ session.titre_evenement }}
                {% endif %}
            {% endif %}
        </div>
        {% if session.professeur %}
        <div class="event-details">
            {{ session.professeur.admin.get_full_name }}
        </div>
        {% endif %}
        <a href="{% url 'supprimer_evenement' session.id %}" 
           class="delete-event" 
           onclick="return confirm('Êtes-vous sûr de vouloir supprimer cet événement ?');">
            <i class="fas fa-times"></i>
        </a>
    </div>
{% else %}
    <div class="full-day-event">
        <div class="event-title">{{ session.titre_evenement }}</div>
        <div class="event-type">{{ session.get_type_evenement_display }}</div>
        <a href="{% url 'supprimer_evenement' session.id %}" 
           class="delete-event" 
           onclick="return confirm('Êtes-vous sûr de vouloir supprimer cet événement ?');">
            <i class="fas fa-times"></i>
        </a>
    </div>
{% endif %}
{% endif %}

<div class="time-slot">
    <!-- Hours header -->
    <div class="hours-header">
        {% for hour in "8,9,10,11,12,13,14,15,16,17,18"|split:"," %}
            <div class="hour-marker">{{ hour }}:00</div>
        {% endfor %}
    </div>
    
    <!-- Events container -->
    <div class="events-container">
        {% for event in events %}
            <div class="event" 
                 style="left: {{ event.get_left_position }}%; 
                        width: {{ event.get_width }}%;"
                 title="{{ event.titre_evenement }}">
                {{ event.get_formatted_hours }}
                {{ event.titre_evenement }}
            </div>
        {% endfor %}
    </div>
</div>

<!-- Remplacer la section du formulaire rapide -->
<div class="quick-add-form">
    <form method="POST" action="{% url 'creer_emploi_temps' %}" class="inline-form" id="quickAddForm">
        {% csrf_token %}
        <input type="hidden" name="type_evenement" value="COURS">
        <input type="hidden" name="promotion" value="{{ promotion_selected }}">
        <input type="hidden" name="date_debut" value="{{ date|date:'Y-m-d' }}">
        
        <div class="form-group mb-2">
            <select name="matiere" class="form-control form-control-sm" required>
                <option value="">Choisir une matière</option>
                {% for subject in subjects %}
                    <option value="{{ subject.id }}">{{ subject.name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="row g-2">
            <div class="col-6">
                <input type="time" name="heure_debut" class="form-control form-control-sm" 
                       min="08:00" max="18:00" required>
            </div>
            <div class="col-6">
                <input type="time" name="heure_fin" class="form-control form-control-sm" 
                       min="08:00" max="18:00" required>
            </div>
        </div>
        
        <button type="submit" class="btn btn-primary btn-sm mt-2 w-100">
            <i class="fas fa-plus"></i> Ajouter
        </button>
    </form>
</div>

<style>
.time-slot {
    width: 100%;
    height: 100px;
    position: relative;
    border: 1px solid #ddd;
    margin-bottom: 10px;
    overflow: hidden; /* Ajout important pour cacher le débordement */
}

.hours-header {
    display: flex;
    position: absolute;
    top: -20px;
    left: 0;
    right: 0;
    height: 20px;
    white-space: nowrap; /* Empêche le passage à la ligne */
}

.hour-marker {
    flex: 1;
    text-align: center;
    font-size: 10px; /* Taille de la police réduite */
    color: #666;
    border-left: 1px solid #ddd;
    overflow: hidden;        /* Ajout important */
    text-overflow: ellipsis;  /* Ajout important */
    width: 10%;              /* Ajout important, ajuste la largeur de chaque marqueur */
}

.events-container {
    position: relative;
    height: 100%;
}

.event {
    position: absolute;
    height: 80%;
    top: 10%;
    background-color: #3498db;
    color: white;
    padding: 4px;
    border-radius: 4px;
    font-size: 18px;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
}

/* Pour les noms longs de matière */
.event-title {
    font-weight: bold;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Pour les noms longs de professeur */
.event-prof {
    font-size: 10px;
    color: #666;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.event-cell {
    position: absolute;
    height: 70px !important;  /* Hauteur fixe plus petite */
    top: 5px;  /* Centrage vertical */
    background: white;
    border-radius: 4px;
    padding: 4px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    overflow: hidden;
    z-index: 2;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 14px;  /* Modifier la taille ici */
    border: 1px solid black;
}

.event-cell.event-examen_partiel {
    background-color: #ffeeba;
    border-color: #ffc107;
}

.event-cell.event-examen_final {
    background-color: #f8d7da;
    border-color: #dc3545;
}

.event-cell.event-rattrapage {
    background-color: #d1ecf1;
    border-color: #17a2b8;
}
</style>
